<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ms_algorithm.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ms_algorithm.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @module ms_algorithm
*/

const {query} = require('./ms_database');

/**
* collectRecipes searches the database for recipes and dietary restrictions
* given by the search obj parameter. It returns rows found in the database.
* If the query fails a 50 Internal Server Error is returned.
*@param searchObj - Search parameter passed by search function.
*@param res - res object represents HTTP response that's sent when it gets an HTTP request.
*/

async function collectRecipes(searchObj, res) {
  try {
    const result = await query('mainSearch', searchObj.parameters);
    return result.rows;
  } catch(err) {
    console.log(err.stack);
    res.sendStatus(500);
  }
}

function filterRecipe(recipe, searchObj) {
  if (searchObj.restrictions) {
    for (const restriction of searchObj.restrictions) {
      if (!(recipe.dietary_restrictions.includes(restriction))) {
        return false;
      }
    }
  }

  if ((searchObj.calories &amp;&amp; recipe.recipe_calories > searchObj.calories) ||
      (searchObj.serving &amp;&amp; recipe.recipe_serving_size &lt; searchObj.serving) ||
      (searchObj.time &amp;&amp; recipe.cooking_minutes > searchObj.time))
      {
    return false;
  }

  return true;
}

function prioritySort(recipes, searchObj) {
  for (const recipe of recipes) {
    recipe.score = searchObj.parameters.length * 2;
    let ingredientsRemaining = recipe.recipe_ingredients.length;

    for (const item of searchObj.parameters) {
      if (recipe.recipe_name.includes(item)) recipe.score -= 1;

      for (const ingredient of recipe.recipe_ingredients) {
        if (ingredient.includes(item)) {
          recipe.score -= 1;
          ingredientsRemaining -= 1;
          break;
        }
      }
    }
    recipe.score += ingredientsRemaining / 10;
    if (searchObj.serving) {
      recipe.score += (recipe.recipe_serving_size - searchObj.serving) / 5;
    }
  }
  return recipes.sort((a, b) => a.score - b.score);
}

async function search(req, res) {
  try {
    const searchObj = req.body;
    const recipes = await collectRecipes(searchObj, res);

    if (recipes.length > 0) {
      const retval = recipes.filter(recipe => filterRecipe(recipe, searchObj));
      if (retval.length === 0) res.sendStatus(404);
      prioritySort(retval, searchObj);
      res.json(retval);
    } else {
      res.sendStatus(404);
    }

  } catch (err) {
    console.log(err.stack);
    res.sendStatus(500);
  }
}

module.exports = {search};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ms_account.html">ms_account</a></li><li><a href="module-ms_algorithm.html">ms_algorithm</a></li><li><a href="module-ms_database.html">ms_database</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sat Mar 21 2020 09:31:38 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
